name: Code Review Request

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]
  push:
    branches:
      - main
      - master

jobs:
  request-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Notify Discord on PR Open/Update
        if: github.event_name == 'pull_request'
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_TITLE="${{ github.event.pull_request.title }}"
          REPO="${{ github.repository }}"
          BRANCH="${{ github.head_ref }}"
          BASE_BRANCH="${{ github.base_ref }}"
          AUTHOR="${{ github.actor }}"
          URL="${{ github.event.pull_request.html_url }}"

          MESSAGE="üîç **New PR: #$PR_NUMBER - $PR_TITLE**"
          MESSAGE+="\n\nüì¶ **Repo:** \`$REPO\`"
          MESSAGE+="\nüåø **Branch:** \`$BRANCH\` ‚Üí \`$BASE_BRANCH\`"
          MESSAGE+="\nüë§ **Author:** @$AUTHOR"
          MESSAGE+="\nüîó **URL:** $URL"

          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "{\"content\": \"$MESSAGE\"}"

      - name: Notify Discord on Review Submit
        if: github.event_name == 'pull_request_review'
        run: |
          STATE="${{ github.event.review.state }}"
          REVIEWER="${{ github.event.review.user.login }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          URL="${{ github.event.pull_request.html_url }}"
          
          if [[ "$STATE" == "APPROVED" ]]; then
            EMOJI="‚úÖ"
            STATUS="Approved"
          elif [[ "$STATE" == "CHANGES_REQUESTED" ]]; then
            EMOJI="‚ùå"
            STATUS="Changes Requested"
          else
            echo "Review state $STATE - skipping notification"
            exit 0
          fi

          MESSAGE="$EMOJI **PR #$PR_NUMBER Review Update**"
          MESSAGE+="\n**Status:** $STATUS by @$REVIEWER"
          MESSAGE+="\nüì¶ **Repo:** \`$REPO\`"
          MESSAGE+="\nüîó **URL:** $URL"

          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "{\"content\": \"$MESSAGE\"}"

      - name: Notify Discord on Main Branch Push
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          AUTHOR="${{ github.actor }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"

          # Get short commit hash
          COMMIT_HASH="${COMMIT_MSG:0:7}"

          MESSAGE="‚ö° **Main Branch Push**"
          MESSAGE+="\n\nüì¶ **Repo:** \`$REPO\`"
          MESSAGE+="\nüåø **Branch:** \`$BRANCH\`"
          MESSAGE+="\nüë§ **Author:** @$AUTHOR"
          MESSAGE+="\nüìù **Commit:** \`$COMMIT_HASH\` - $COMMIT_MSG"
          MESSAGE+="\nüîó **URL:** https://github.com/$REPO/commit/${{ github.sha }}"

          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d "{\"content\": \"$MESSAGE\"}"
