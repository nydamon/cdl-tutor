<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Call Red - CDL Tutor</title>
    <style>
        body { background: #1a1a2e; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .status { margin-bottom: 2rem; color: #a8a8b3; font-size: 1.2rem; }
        .call-btn { width: 220px; height: 220px; border-radius: 50%; border: none; background: #e94560; color: white; font-size: 1.6rem; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px rgba(233, 69, 96, 0.4); }
        .call-btn.active { background: #27ae60; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.4); } 70% { box-shadow: 0 0 0 40px rgba(39, 174, 96, 0); } 100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); } }
    </style>
</head>
<body>
    <div style="position: absolute; top: 20px; right: 20px;">
        <a href="/" style="color: #a8a8b3; text-decoration: none; font-size: 0.9rem; border: 1px solid #2d2d44; padding: 5px 15px; border-radius: 15px;">VIEW STATS ðŸ“Š</a>
    </div>
    <div class="status" id="status">Ready to call Red?</div>
    <button class="call-btn" id="callBtn">START CALL</button>

    <script>
        let peerConnection;
        let audioStream;
        const callBtn = document.getElementById('callBtn');
        const statusEl = document.getElementById('status');

        async function initWebRTC() {
            try {
                statusEl.textContent = "Connecting...";
                
                const tokenResponse = await fetch('/api/realtime-token');
                const data = await tokenResponse.json();
                const EPHEMERAL_KEY = data.client_secret.value;

                peerConnection = new RTCPeerConnection();

                const audioEl = document.createElement("audio");
                audioEl.autoplay = true;
                peerConnection.ontrack = (e) => audioEl.srcObject = e.streams[0];

                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                peerConnection.addTrack(audioStream.getTracks()[0]);

                // ------------------ DATA CHANNEL FOR PERSISTENCE ------------------
                const dc = peerConnection.createDataChannel("oai-events");
                dc.onmessage = (e) => {
                    const event = JSON.parse(e.data);
                    
                    // Save transcripts to DB as they arrive
                    if (event.type === 'response.audio_transcript.done' || event.type === 'conversation.item.input_audio_transcription.completed') {
                        const transcript = event.transcript || event.text;
                        const role = event.type.includes('response') ? 'assistant' : 'user';
                        
                        if (transcript) {
                            fetch('/api/save-voice-transcript', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ transcript, role })
                            }).catch(err => console.error("Persistence failed:", err));
                        }
                    }
                };
                // ------------------------------------------------------------------

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                const baseUrl = "https://api.openai.com/v1/realtime";
                const model = "gpt-4o-realtime-preview";
                const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
                    method: "POST",
                    body: offer.sdp,
                    headers: {
                        Authorization: `Bearer ${EPHEMERAL_KEY}`,
                        "Content-Type": "application/sdp"
                    },
                });

                const answer = {
                    type: "answer",
                    sdp: await sdpResponse.text(),
                };
                await peerConnection.setRemoteDescription(answer);

                statusEl.textContent = "CONNECTED TO RED";
                callBtn.classList.add('active');
                callBtn.textContent = "HANG UP";

            } catch (err) {
                statusEl.textContent = "Failed: " + err.message;
                console.error(err);
            }
        }

        callBtn.onclick = () => {
            if (peerConnection) {
                location.reload();
            } else {
                initWebRTC();
            }
        };
    </script>
</body>
</html>
